<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triangolazione GPS con OpenLayers</title>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        #map {
            width: 100%;
            height: 50vh;
            position: relative;
        }
        
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .mobile-controls {
            display: flex;
            flex-direction: column;
            height: 50vh;
            padding: 5px;
            background: #f5f5f5;
        }
        
        .control-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex: 1;
        }
        
        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        button {
            min-height: 44px;
            padding: 8px 4px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            touch-action: manipulation;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        #disableGPS {
            background-color: #f44336;
        }
        
        #resetRotation {
            background-color: #2196F3;
        }
        
        #undo {
            background-color: #FF9800;
        }
        
        #clear {
            background-color: #795548;
        }
        
        .status {
            margin-top: 5px;
            font-size: 11px;
            text-align: center;
            color: #666;
            padding: 2px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .build-info {
            font-size: 9px;
            color: #888;
            text-align: center;
            margin-top: 2px;
        }
        
        /* Pulsante largo */
        .wide-button {
            width: 100%;
            margin-bottom: 5px;
        }
        
        /* Pulsanti normali */
        .normal-button {
            flex: 1;
        }
        
        /* Indicatore centrale */
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
        }
        
        .center-crosshair {
            width: 20px;
            height: 20px;
            border: 2px solid red;
            border-radius: 50%;
            background: transparent;
            position: relative;
        }
        
        .center-crosshair::before,
        .center-crosshair::after {
            content: '';
            position: absolute;
            background: red;
        }
        
        .center-crosshair::before {
            width: 2px;
            height: 30px;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .center-crosshair::after {
            width: 30px;
            height: 2px;
            top: 50%;
            left: -5px;
            transform: translateY(-50%);
        }
        
        /* Indicatore di direzione (triangolo fisso) */
        .direction-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            pointer-events: none;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid rgba(255, 0, 0, 0.7);
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }
        
        /* Bussola grafica */
        .compass-graphic {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: black;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .compass-rose {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            transition: transform 0.1s ease;
        }
        
        .compass-north {
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 40px;
            background: yellow;
            border-radius: 2px;
        }
        
        .compass-direction {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: white;
            font-weight: bold;
        }
        
        /* Stili per gli slider */
        .slider-container {
            margin: 5px 0;
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 11px;
            color: #333;
        }
        
        .slider-name {
            font-weight: bold;
        }
        
        .slider-value {
            color: #666;
        }
        
        .slider {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .sliders-title {
            margin: 8px 0 5px 0;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }
        
        .help-text {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 3px;
            font-style: italic;
            padding: 3px;
            background: #e9f7e9;
            border-radius: 4px;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            #map {
                height: 100vh;
            }
            
            .controls {
                top: 10px;
                right: 10px;
                bottom: auto;
                left: auto;
                width: 250px;
                max-height: none;
                overflow: visible;
            }
            
            .mobile-controls {
                display: none;
            }
            
            button {
                min-height: auto;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .compass-graphic {
                width: 80px;
                height: 80px;
                top: 80px;
            }
            
            .compass-rose {
                width: 70px;
                height: 70px;
            }
            
            .compass-north {
                font-size: 14px;
                top: 5px;
            }
            
            .compass-direction {
                font-size: 12px;
                bottom: 5px;
            }
        }
        
        /* Overlay di conferma */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .confirm-dialog {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 300px;
            width: 100%;
        }
        
        .confirm-dialog p {
            margin: 0 0 20px 0;
            font-size: 16px;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .confirm-buttons button {
            flex: 1;
            margin: 0;
            min-height: 44px;
            font-size: 16px;
        }
        
        .confirm-yes {
            background-color: #f44336;
        }
        
        .confirm-no {
            background-color: #9e9e9e;
        }
        
        /* Pulsante toggle per mobile */
        .mobile-toggle {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1001;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 767px) {
            .mobile-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Indicatore centrale sempre visibile -->
    <div class="center-marker">
        <div class="center-crosshair"></div>
    </div>
    
    <!-- Indicatore di direzione (triangolo fisso) -->
    <div class="direction-indicator"></div>
    
    <!-- Controlli desktop -->
    <div class="controls">
        <div class="build-info">Build: 5.12 (Layout Migliorato)</div>
        
        <!-- Pulsante Aggiungi Triangolo largo -->
        <button id="submit" class="wide-button">Aggiungi Triangolo</button>
        
        <!-- Seconda riga: altri pulsanti -->
        <div class="control-row">
            <button id="disableGPS" class="normal-button">DISABLE GPS</button>
            <button id="enableGPS" class="normal-button" style="display:none;">ENABLE GPS</button>
            <button id="resetRotation" class="normal-button">Reset Rotazione</button>
            <button id="undo" class="normal-button">UNDO</button>
            <button id="clear" class="normal-button">CLEAR</button>
        </div>
        
        <div class="sliders-title">Regola Triangolo</div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Larghezza Base</span>
                <span class="slider-value" id="baseWidthValue">500 m</span>
            </div>
            <input type="range" min="100" max="2000" value="500" class="slider" id="baseWidthSlider">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Altezza</span>
                <span class="slider-value" id="baseDistanceValue">1000 m</span>
            </div>
            <input type="range" min="100" max="20000" value="1000" class="slider" id="baseDistanceSlider">
        </div>
        
        <div class="sliders-title">Calibrazione Bussola</div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Correzione Nord</span>
                <span class="slider-value" id="compassCorrectionValue">0°</span>
            </div>
            <input type="range" min="-45" max="45" value="0" class="slider" id="compassCorrectionSlider">
        </div>
        
        <div class="help-text">CTRL + Trascina orizzontalmente per ruotare</div>
        <div class="status" id="status">GPS attivo</div>
    </div>
    
    <!-- Controlli mobile -->
    <div class="mobile-controls">
        <div class="build-info">Build: 5.12 (Layout Migliorato)</div>
        
        <!-- Pulsante Aggiungi Triangolo largo -->
        <button id="submitMobile" class="wide-button">Aggiungi Triangolo</button>
        
        <!-- Seconda riga: altri pulsanti -->
        <div class="control-row">
            <button id="disableGPSMobile" class="normal-button">DISABLE GPS</button>
            <button id="enableGPSMobile" class="normal-button" style="display:none;">ENABLE GPS</button>
            <button id="resetRotationMobile" class="normal-button">Reset Rotazione</button>
            <button id="undoMobile" class="normal-button">UNDO</button>
            <button id="clearMobile" class="normal-button">CLEAR</button>
        </div>
        
        <!-- Terza riga: slider triangolo -->
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Larghezza Base</span>
                <span class="slider-value" id="baseWidthValueMobile">500 m</span>
            </div>
            <input type="range" min="100" max="2000" value="500" class="slider" id="baseWidthSliderMobile">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Altezza</span>
                <span class="slider-value" id="baseDistanceValueMobile">1000 m</span>
            </div>
            <input type="range" min="100" max="20000" value="1000" class="slider" id="baseDistanceSliderMobile">
        </div>
        
        <!-- Quarta riga: calibrazione bussola -->
        <div class="slider-container">
            <div class="slider-label">
                <span class="slider-name">Correzione Nord</span>
                <span class="slider-value" id="compassCorrectionValueMobile">0°</span>
            </div>
            <input type="range" min="-45" max="45" value="0" class="slider" id="compassCorrectionSliderMobile">
        </div>
        
        <!-- Status -->
        <div class="status" id="statusMobile">GPS attivo - Modalità navigazione</div>
    </div>
    
    <!-- Bussola grafica -->
    <div class="compass-graphic">
        <div class="compass-rose" id="compassRose">
            <div class="compass-north">N</div>
            <div class="compass-needle"></div>
            <div class="compass-direction" id="compassDirection">0°</div>
        </div>
    </div>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <script>
        // Numero di build
        const BUILD_NUMBER = "5.11 (Fix Rotazione Manuale)";
        
        // Variabili globali
        let map;
        let view;
        let userMarker;
        let watchId;
        let gpsEnabled = true;
        let triangles = [];
        let currentRotation = 0;
        let isRotating = false;
        let controlPressed = false;
        let rotationStartX = 0;
        let previousRotation = 0;
        let deviceOrientationHandler = null;
        let deviceOrientationAlpha = 0;
        let compassCorrection = 0;
        
        // Variabili per i slider
        let baseWidth = 500;
        let baseDistance = 1000;
        
        // Struttura per memorizzare i triangoli
        let triangleData = [];
        
        // Layer per i triangoli
        let triangleLayer;
        let triangleSource;
        
        // Rileva se è mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Carica le impostazioni salvate
        function loadSettings() {
            const savedCorrection = localStorage.getItem('compassCorrection');
            if (savedCorrection !== null) {
                compassCorrection = parseInt(savedCorrection);
                document.getElementById('compassCorrectionSlider').value = compassCorrection;
                document.getElementById('compassCorrectionSliderMobile').value = compassCorrection;
                updateCompassCorrectionValue();
            }
            
            const savedBaseDistance = localStorage.getItem('baseDistance');
            if (savedBaseDistance !== null) {
                baseDistance = parseInt(savedBaseDistance);
                document.getElementById('baseDistanceSlider').value = baseDistance;
                document.getElementById('baseDistanceSliderMobile').value = baseDistance;
                document.getElementById('baseDistanceValue').textContent = baseDistance + ' m';
                document.getElementById('baseDistanceValueMobile').textContent = baseDistance + ' m';
            }
            
            const savedBaseWidth = localStorage.getItem('baseWidth');
            if (savedBaseWidth !== null) {
                baseWidth = parseInt(savedBaseWidth);
                document.getElementById('baseWidthSlider').value = baseWidth;
                document.getElementById('baseWidthSliderMobile').value = baseWidth;
                document.getElementById('baseWidthValue').textContent = baseWidth + ' m';
                document.getElementById('baseWidthValueMobile').textContent = baseWidth + ' m';
            }
        }
        
        // Salva le impostazioni
        function saveSettings() {
            localStorage.setItem('compassCorrection', compassCorrection);
            localStorage.setItem('baseDistance', baseDistance);
            localStorage.setItem('baseWidth', baseWidth);
        }
        
        // Inizializzazione della mappa
        function initMap() {
            // Carica le impostazioni salvate
            loadSettings();
            
            // Crea la vista centrata su Roma
            view = new ol.View({
                center: ol.proj.fromLonLat([12.4964, 41.9028]),
                zoom: 15,
                rotation: 0
            });
            
            // Crea la mappa
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: view
            });
            
            // Crea il layer per i triangoli
            triangleSource = new ol.source.Vector();
            triangleLayer = new ol.layer.Vector({
                source: triangleSource,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(51, 136, 255, 0.3)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'blue',
                        width: 2
                    })
                })
            });
            map.addLayer(triangleLayer);
            
            // Crea il marker dell'utente (cerchio fisso, non triangolo)
            userMarker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([0, 0]))
            });
            
            const userMarkerStyle = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({color: 'red'}),
                    stroke: new ol.style.Stroke({color: 'white', width: 2})
                })
            });
            userMarker.setStyle(userMarkerStyle);
            
            const userMarkerSource = new ol.source.Vector({
                features: [userMarker]
            });
            
            const userMarkerLayer = new ol.layer.Vector({
                source: userMarkerSource
            });
            map.addLayer(userMarkerLayer);
            
            // Configura gli eventi
            setupMapEvents();
            setupSliders();
            
            // Applica la rotazione iniziale
            applyMapRotation();
            
            // Avvia il tracciamento GPS
            startGPS();
            
            // Setup per mobile
            if (isMobile) {
                setupMobileFeatures();
            }
        }
        
        // Setup per funzionalità mobile
        function setupMobileFeatures() {
            // Attiva l'orientamento del dispositivo
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ - richiedi permesso
                document.getElementById('statusMobile').textContent = "Tocca per abilitare la modalità navigazione";
                
                const enableOrientation = () => {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startDeviceOrientation();
                                document.getElementById('statusMobile').textContent = "GPS attivo - Modalità navigazione";
                            }
                        })
                        .catch(console.error);
                };
                
                // Aggiungi event listener per il primo tap
                const onceTap = () => {
                    enableOrientation();
                    document.removeEventListener('click', onceTap);
                    document.removeEventListener('touchstart', onceTap);
                };
                
                document.addEventListener('click', onceTap);
                document.addEventListener('touchstart', onceTap);
            } else {
                // Altri browser - avvia direttamente
                startDeviceOrientation();
            }
        }
        
        // Avvia il tracking dell'orientamento del dispositivo
        function startDeviceOrientation() {
            deviceOrientationHandler = (event) => {
                // Ottieni l'orientamento dal dispositivo (bussola)
                let alpha = event.alpha; // 0-360 gradi, bussola
                
                if (alpha !== null) {
                    deviceOrientationAlpha = alpha;
                    updateCompass();
                    
                    if (gpsEnabled) {
                        // Formula corretta per la modalità navigazione con correzione
                        const correctedAlpha = 270 - (alpha + compassCorrection);
                        currentRotation = (360 - correctedAlpha) * Math.PI / 180;
                        applyMapRotation();
                    }
                }
            };
            
            window.addEventListener('deviceorientation', deviceOrientationHandler);
        }
        
        // Configura gli eventi della mappa
        function setupMapEvents() {
            const mapContainer = map.getTargetElement();
            
            // Eventi per il tasto Control (solo desktop)
            if (!isMobile) {
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Control' && !gpsEnabled) {
                        controlPressed = true;
                        mapContainer.style.cursor = 'grab';
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('keyup', function(e) {
                    if (e.key === 'Control') {
                        controlPressed = false;
                        isRotating = false;
                        mapContainer.style.cursor = '';
                    }
                });
                
                // Mouse events per rotazione (solo desktop)
                mapContainer.addEventListener('mousedown', function(e) {
                    if (controlPressed && !gpsEnabled && e.button === 0) {
                        isRotating = true;
                        rotationStartX = e.clientX;
                        previousRotation = currentRotation;
                        mapContainer.style.cursor = 'grabbing';
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (isRotating && controlPressed && !gpsEnabled) {
                        const deltaX = e.clientX - rotationStartX;
                        const rotationDelta = deltaX * 0.005;
                        currentRotation = previousRotation + rotationDelta;
                        applyMapRotation();
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                document.addEventListener('mouseup', function(e) {
                    if (isRotating && e.button === 0) {
                        isRotating = false;
                        if (controlPressed) {
                            mapContainer.style.cursor = 'grab';
                        }
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            }
        }
        
        // Configura gli slider
        function setupSliders() {
            // Slider desktop
            setupSliderPair('baseWidthSlider', 'baseWidthValue', 'baseWidthSliderMobile', 'baseWidthValueMobile');
            setupSliderPair('baseDistanceSlider', 'baseDistanceValue', 'baseDistanceSliderMobile', 'baseDistanceValueMobile');
            setupCompassCorrectionSlider();
        }
        
        function setupSliderPair(desktopSliderId, desktopValueId, mobileSliderId, mobileValueId) {
            const desktopSlider = document.getElementById(desktopSliderId);
            const desktopValue = document.getElementById(desktopValueId);
            const mobileSlider = document.getElementById(mobileSliderId);
            const mobileValue = document.getElementById(mobileValueId);
            
            function updateValue(value) {
                if (desktopSliderId === 'baseWidthSlider') baseWidth = value;
                if (desktopSliderId === 'baseDistanceSlider') baseDistance = value;
                
                desktopValue.textContent = value + ' m';
                if (mobileValue) mobileValue.textContent = value + ' m';
                updateAllTriangles();
                saveSettings();
            }
            
            desktopSlider.addEventListener('input', function() {
                updateValue(parseInt(this.value));
            });
            
            if (mobileSlider) {
                mobileSlider.addEventListener('input', function() {
                    updateValue(parseInt(this.value));
                    desktopSlider.value = this.value;
                });
            }
        }
        
        function setupCompassCorrectionSlider() {
            const desktopSlider = document.getElementById('compassCorrectionSlider');
            const mobileSlider = document.getElementById('compassCorrectionSliderMobile');
            
            function updateCorrection(value) {
                compassCorrection = parseInt(value);
                updateCompassCorrectionValue();
                saveSettings();
                
                // Ricalcola la rotazione della mappa con la nuova correzione
                if (gpsEnabled && deviceOrientationAlpha !== null) {
                    const correctedAlpha = 270 - (deviceOrientationAlpha + compassCorrection);
                    currentRotation = (360 - correctedAlpha) * Math.PI / 180;
                    applyMapRotation();
                }
            }
            
            desktopSlider.addEventListener('input', function() {
                updateCorrection(this.value);
                mobileSlider.value = this.value;
            });
            
            mobileSlider.addEventListener('input', function() {
                updateCorrection(this.value);
                desktopSlider.value = this.value;
            });
        }
        
        function updateCompassCorrectionValue() {
            const sign = compassCorrection >= 0 ? '+' : '';
            document.getElementById('compassCorrectionValue').textContent = sign + compassCorrection + '°';
            document.getElementById('compassCorrectionValueMobile').textContent = sign + compassCorrection + '°';
        }
        
        // Applica la rotazione alla mappa
        function applyMapRotation() {
            view.setRotation(currentRotation);
        }
        
        // Aggiorna la bussola grafica
        function updateCompass() {
            const compassRose = document.getElementById('compassRose');
            const compassDirection = document.getElementById('compassDirection');
            
            // Usa deviceOrientationAlpha con correzione per la bussola
            const correctedAlpha = (deviceOrientationAlpha + compassCorrection) % 360;
            const normalizedDegrees = (correctedAlpha % 360 + 360) % 360;
            
            // La bussola ruota con l'orientamento del dispositivo corretto
            compassRose.style.transform = `rotate(${normalizedDegrees}deg)`;
            compassDirection.textContent = Math.round(normalizedDegrees) + '°';
        }
        
        // Aggiorna tutti i triangoli esistenti
        function updateAllTriangles() {
            triangleSource.clear();
            triangles = [];
            
            const oldTriangleData = [...triangleData];
            triangleData = [];
            
            oldTriangleData.forEach(data => {
                createTriangle(data.observerPoint);
            });
        }
        
        // Resetta la rotazione
        function resetRotation() {
            currentRotation = 0;
            applyMapRotation();
        }
        
        // Rimuove l'ultimo triangolo
        function undoLastTriangle() {
            if (triangles.length === 0) {
                alert("Non ci sono triangoli da rimuovere.");
                return;
            }
            
            showConfirmDialog(
                "Vuoi davvero rimuovere l'ultimo triangolo?",
                function() {
                    const lastTriangle = triangles.pop();
                    const lastTriangleData = triangleData.pop();
                    
                    if (lastTriangle) {
                        triangleSource.removeFeature(lastTriangle);
                    }
                    
                    updateStatus(`Rimosso ultimo triangolo. Rimangono: ${triangles.length}`);
                }
            );
        }
        
        // Rimuove tutti i triangoli
        function clearAllTriangles() {
            if (triangles.length === 0) {
                alert("Non ci sono triangoli da rimuovere.");
                return;
            }
            
            showConfirmDialog(
                "Vuoi davvero rimuovere tutti i triangoli?",
                function() {
                    triangleSource.clear();
                    triangles = [];
                    triangleData = [];
                    
                    updateStatus("Tutti i triangoli sono stati rimossi.");
                }
            );
        }
        
        // Mostra un dialog di conferma
        function showConfirmDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            
            const messageEl = document.createElement('p');
            messageEl.textContent = message;
            dialog.appendChild(messageEl);
            
            const buttons = document.createElement('div');
            buttons.className = 'confirm-buttons';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Sì';
            yesButton.className = 'confirm-yes';
            yesButton.onclick = function() {
                document.body.removeChild(overlay);
                onConfirm();
            };
            
            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.className = 'confirm-no';
            noButton.onclick = function() {
                document.body.removeChild(overlay);
            };
            
            buttons.appendChild(yesButton);
            buttons.appendChild(noButton);
            dialog.appendChild(buttons);
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }
        
        // Avvia il tracciamento GPS
        function startGPS() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleGeolocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                updateStatus("GPS attivo" + (isMobile ? " - Modalità navigazione" : ""));
                gpsEnabled = true;
                
                // Riavvia l'orientamento del dispositivo se era stato fermato
                if (isMobile && !deviceOrientationHandler) {
                    startDeviceOrientation();
                }
                
                // Aggiorna interfaccia
                document.getElementById('disableGPS').style.display = 'block';
                document.getElementById('enableGPS').style.display = 'none';
                document.getElementById('disableGPSMobile').style.display = 'block';
                document.getElementById('enableGPSMobile').style.display = 'none';
            } else {
                alert("La geolocalizzazione non è supportata da questo browser.");
            }
        }
        
        // Ferma il tracciamento GPS
        function stopGPS() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            updateStatus("GPS disattivo");
            gpsEnabled = false;
            
            // Aggiorna interfaccia
            document.getElementById('disableGPS').style.display = 'none';
            document.getElementById('enableGPS').style.display = 'block';
            document.getElementById('disableGPSMobile').style.display = 'none';
            document.getElementById('enableGPSMobile').style.display = 'block';
        }
        
        // Aggiorna la posizione dell'utente sulla mappa
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const coords = ol.proj.fromLonLat([lng, lat]);
            
            userMarker.setGeometry(new ol.geom.Point(coords));
            
            if (gpsEnabled) {
                view.setCenter(coords);
                
                // Su desktop, usa l'heading del GPS se disponibile
                if (position.coords.heading !== null && !isMobile) {
                    currentRotation = -position.coords.heading * Math.PI / 180;
                    applyMapRotation();
                }
            }
        }
        
        // Gestisce gli errori di geolocalizzazione
        function handleGeolocationError(error) {
            let message;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permesso di geolocalizzazione negato.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Informazioni sulla posizione non disponibili.";
                    break;
                case error.TIMEOUT:
                    message = "Richiesta di geolocalizzazione scaduta.";
                    break;
                default:
                    message = "Errore sconosciuto nella geolocalizzazione.";
            }
            updateStatus("Errore GPS: " + message);
        }
        
        // Calcola un punto di destinazione date coordinate, direzione e distanza
        function calculateDestinationPoint(startPoint, bearing, distance) {
            const R = 6371000;
            const lat1 = startPoint[1] * Math.PI / 180;
            const lon1 = startPoint[0] * Math.PI / 180;
            const brng = bearing * Math.PI / 180;
            
            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(distance / R) +
                Math.cos(lat1) * Math.sin(distance / R) * Math.cos(brng));
            
            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(distance / R) * Math.cos(lat1),
                Math.cos(distance / R) - Math.sin(lat1) * Math.sin(lat2));
            
            return [lon2 * 180 / Math.PI, lat2 * 180 / Math.PI];
        }
        
        // Crea un triangolo
        function createTriangle(observerPoint) {
            const observerLonLat = ol.proj.toLonLat(observerPoint);
            
            // CORREZIONE: Usa SEMPRE la rotazione attuale della mappa
            // Questa può essere impostata dal GPS O manualmente dall'utente
            const currentMapRotation = view.getRotation(); // Ottieni la rotazione attuale della mappa
            const directionTowardsTop = (360 - (currentMapRotation * 180 / Math.PI)) % 360;
            
            const baseCenter = calculateDestinationPoint(observerLonLat, directionTowardsTop, baseDistance);
            const baseLeft = calculateDestinationPoint(baseCenter, directionTowardsTop - 90, baseWidth / 2);
            const baseRight = calculateDestinationPoint(baseCenter, directionTowardsTop + 90, baseWidth / 2);
            
            const observerCoords = observerPoint;
            const baseCenterCoords = ol.proj.fromLonLat(baseCenter);
            const baseLeftCoords = ol.proj.fromLonLat(baseLeft);
            const baseRightCoords = ol.proj.fromLonLat(baseRight);
            
            const triangle = new ol.Feature({
                geometry: new ol.geom.Polygon([[
                    observerCoords,
                    baseLeftCoords,
                    baseRightCoords,
                    observerCoords
                ]])
            });
            
            triangles.push(triangle);
            triangleSource.addFeature(triangle);
            
            triangleData.push({
                observerPoint: observerPoint
            });
            
            return triangle;
        }
        
        // Aggiunge un triangolo alla mappa
        function addTriangle() {
            let observerPoint;
            
            if (gpsEnabled) {
                observerPoint = userMarker.getGeometry().getCoordinates();
            } else {
                observerPoint = view.getCenter();
            }
            
            // Il triangolo deve sempre partire dal centro e andare verso l'alto
            createTriangle(observerPoint);
            updateStatus(`Triangolo aggiunto. Totale: ${triangles.length}`);
        }
        
        // Aggiorna lo stato del GPS
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            document.getElementById('statusMobile').textContent = message;
        }
        
        // Inizializza tutto quando la pagina è caricata
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Gestione pulsanti desktop
            document.getElementById('submit').addEventListener('click', addTriangle);
            document.getElementById('disableGPS').addEventListener('click', stopGPS);
            document.getElementById('enableGPS').addEventListener('click', startGPS);
            document.getElementById('resetRotation').addEventListener('click', resetRotation);
            document.getElementById('undo').addEventListener('click', undoLastTriangle);
            document.getElementById('clear').addEventListener('click', clearAllTriangles);
            
            // Gestione pulsanti mobile
            document.getElementById('submitMobile').addEventListener('click', addTriangle);
            document.getElementById('disableGPSMobile').addEventListener('click', stopGPS);
            document.getElementById('enableGPSMobile').addEventListener('click', startGPS);
            document.getElementById('resetRotationMobile').addEventListener('click', resetRotation);
            document.getElementById('undoMobile').addEventListener('click', undoLastTriangle);
            document.getElementById('clearMobile').addEventListener('click', clearAllTriangles);
        });
    </script>
</body>
</html>
